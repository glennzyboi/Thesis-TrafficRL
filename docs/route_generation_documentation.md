# Route Generation Process Documentation

## Introduction

This document details the `generate_routes_from_scenarios.py` script, which is a crucial component of the adaptive traffic-signal control thesis project. Its primary function is to convert preprocessed camera-derived traffic data, organized into scenario CSVs, into SUMO-compatible `.rou.xml` route files. These route files are essential for simulating traffic demand within the SUMO environment, forming the basis for training and evaluating Reinforcement Learning (RL) agents for traffic signal control.

## Purpose and Context

The overarching goal of this thesis is to implement a Multi-Agent Reinforcement Learning (MARL) system for traffic signal control across three specific intersections: Ecoland, JohnPaul, and Sandawa. The RL agents will prioritize passenger throughput, using synchronized cycle data as their shared state. The `generate_routes_from_scenarios.py` script bridges the gap between the real-world observed traffic patterns (captured in scenario CSVs) and the simulated environment in SUMO. It ensures that the simulated traffic accurately reflects the observed vehicle counts and compositions, while also introducing necessary randomization for robust RL training.

## Input Data Structure

The script expects input from scenario CSV files located in the `out/scenarios/<day>/` directory within the project structure. These CSVs are generated by the `generate_scenarios.py` script (from the user's existing pipeline) and contain per-cycle vehicle counts for each intersection. A typical scenario CSV file (e.g., `out/scenarios/2025-09-09/cycle_1_Ecoland.csv`) is expected to have columns representing different vehicle classes (e.g., `car`, `motor`, `jeepney`, `bus`, `truck`, `tricycle`), with the values indicating the count of each vehicle type for that specific cycle and intersection.

## Vehicle Type Definitions and PCU Consideration

The script defines various vehicle types (`VEHICLE_TYPES` dictionary) that correspond to the vehicle classes in the input CSVs. Each vehicle type is associated with a Passenger Car Unit (PCU) equivalent and a typical length. These parameters are used to generate appropriate `<vType>` definitions in the `.rou.xml` files, influencing how vehicles behave and occupy space within the SUMO simulation. While SUMO does not directly interpret PCU, the assigned `vType_params` (e.g., `accel`, `decel`, `minGap`, `maxSpeed`) are chosen to reflect the real-world characteristics and road occupancy of these vehicle types, thereby indirectly accounting for PCU where possible. This aligns with the thesis's focus on prioritizing passenger throughput, as larger PCU vehicles (like buses and trucks) represent a higher capacity for moving people.

## Route Generation Logic

### From Flows to Individual Vehicles

Initially, the script attempted to use `<flow>` definitions in SUMO route files. However, due to persistent issues with SUMO's internal routing for flows on the provided network, the approach was revised to generate individual `<vehicle>` tags. This provides more explicit control over each vehicle's route and departure, which has proven more reliable for this specific network.

### Precomputing Valid Routes

One of the most significant challenges in generating runnable SUMO simulations for the provided `ThesisNetowrk.net.xml` has been the "no valid route" error. To address this, the script incorporates a route precomputation step (`precompute_valid_routes` function). This function performs the following:

1.  **TraCI Integration:** It starts a headless SUMO simulation using TraCI (Traffic Control Interface) to leverage SUMO's internal routing capabilities.
2.  **Edge Filtering:** It identifies all external (non-internal) edges in the network, as these are typically the valid start and end points for vehicle routes.
3.  **Route Discovery:** For a sampled subset of source and destination external edge pairs, it uses `traci.simulation.findRoute()` to attempt to find a valid path. This function returns a list of edge IDs that form a continuous route.
4.  **SUMO Validation:** Crucially, each route found by `traci.simulation.findRoute()` is further validated by running a very short, quick SUMO simulation (`test_route_in_sumo` function). This step checks if SUMO can actually instantiate a vehicle with that route without immediately reporting a "no valid route" error. This is a critical filter, as `findRoute` can sometimes return paths that SUMO's main simulation struggles with.
5.  **Caching:** The successfully validated routes (lists of edge IDs) are cached to a pickle file (`../network/valid_routes_cache.pkl`). This significantly speeds up subsequent route generation runs, as the computationally intensive precomputation only needs to happen once or when the network file changes.

### Random Route Selection and Vehicle Spawning

During the actual route file generation (`generate_route_file_from_scenario` function):

1.  **Random Route Assignment:** For each vehicle to be spawned, a random valid route is selected from the precomputed and cached list.
2.  **Departure Time Randomization:** Vehicle departure times are randomized within the specified `begin_time` and `end_time` of the scenario, ensuring a distributed traffic flow rather than all vehicles appearing at once.
3.  **Lane and Position Randomization:** `departLane="random"` and `departPos="random"` are used to further randomize the starting position of vehicles on their initial lane, adding to the realism of the simulation.

## Usage

To use the `generate_routes_from_scenarios.py` script:

1.  **Ensure SUMO is Installed:** Make sure SUMO is installed on your system and the `SUMO_HOME` environment variable is correctly set.
2.  **Network File:** Place your SUMO network file (e.g., `ThesisNetowrk.net.xml`) in the `network/` directory. If you have run `netconvert` on it, use the validated version (e.g., `ThesisNetowrk_validated.net.xml`).
3.  **Scenario CSVs:** Ensure your preprocessed scenario CSV files are located in the `out/scenarios/<day>/` directories. You can use the `scripts/generate_dummy_scenarios.py` script to create placeholder CSVs for testing if you don't have real data yet.
4.  **Run the Script:** Navigate to the `scripts/` directory in your terminal and run the script:
    ```bash
    python3 generate_routes_from_scenarios.py
    ```
    The first run will trigger the route precomputation, which can take a significant amount of time depending on the network size and complexity. Subsequent runs will be much faster as they will use the cached routes.
5.  **Output:** The generated `.rou.xml` files will be saved in the `traffic_files/generated_routes/` directory.

## Limitations and Future Work

Despite the robust route precomputation and validation, the `ThesisNetowrk.net.xml` provided has shown persistent "no valid route" errors during SUMO simulations, even for routes identified as valid by `traci.simulation.findRoute()` and the `test_route_in_sumo` function. This suggests that the network itself might contain subtle topological issues or complexities that make it challenging for SUMO's internal router to consistently find paths for all possible source-destination pairs. These issues are often related to very short edges, complex junction definitions, or turn restrictions that are not immediately apparent.

**Recommendations for Future Work:**

*   **Network Inspection and Correction:** If persistent routing errors occur, it is highly recommended to use SUMO's `netedit` tool to visually inspect and potentially simplify or correct the network topology. Pay close attention to junctions, very short edges, and turn definitions.
*   **Advanced Routing Algorithms:** For highly complex networks, consider integrating more advanced routing algorithms or graph analysis libraries (e.g., NetworkX) to pre-process the network and identify truly viable routes.
*   **Dynamic Route Generation:** For very large-scale simulations, generating all routes beforehand might be memory-intensive. Investigate dynamic route generation strategies during simulation runtime, though this adds complexity.


## References

[1] SUMO - Simulation of Urban MObility. (n.d.). Retrieved from [https://sumo.dlr.de/](https://sumo.dlr.de/)
[2] TraCI (Traffic Control Interface) - SUMO Documentation. (n.d.). Retrieved from [https://sumo.dlr.de/docs/TraCI.html](https://sumo.dlr.de/docs/TraCI.html)
[3] sumolib - SUMO Documentation. (n.d.). Retrieved from [https://sumo.dlr.de/docs/Tools/Sumolib.html](https://sumo.dlr.de/docs/Tools/Sumolib.html)


